{{#cp-panels accordion=true as |panels|}}
    {{#if nodeLocked}}
        {{#panels.panel class="upload-section-block" allowOpen=false name='locationOfPreprint' open=false as |panel|}}
            {{preprint-form-header id="locked-section" name="location_of_preprint" node=node selectedNode=selectedNode showValidationIndicator=false}}
            {{#panel.body}}
            {{/panel.body}}
        {{/panels.panel}}
    {{else}}
        {{#panels.panel class="upload-section-block" allowOpen=true name='chooseProject' open=true as |panel|}}
            {{preprint-form-section class="upload-section-block" allowOpen=true name='chooseProject' open=true}}
            {{#panel.body}}
                <div class="m-t-sm">
                    {{#power-select search=(perform _getInitialUserNodes) optionsComponent=(component 'lazy-options' loadMore=(action "getMoreUserNodes") isLoading=isLoading canLoadMore=canLoadMore) oninput=(action "getDefaultUserNodes") onfocus=(action "onFocus") onblue=(action "onBlur") options=userNodes placeholder="Click to select" selected=selectedNode onchange=(action "nodeSelected") as |node|}}
                        {{get-ancestor-descriptor node}} <strong> {{node.title}}</strong>
                    {{/power-select}}
                </div>
                <p class="text-muted text-smaller m-t-xs">
                    {{t "components.preprint-form-project-select.existing_project_selector"}}
                </p>
            {{/panel.body}}
        {{/panels.panel}}
    {{/if}}
    {{#if selectedNode}}
        {{#if isAdmin}}
            {{#if (and fileSelect (eq existingState _existingState.CHOOSE))}} {{!FILE DECISION SECTION - UPLOAD OR CHOOSE EXISTING}}
                {{#panels.panel class="upload-section-block" allowOpen=true name='chooseFile' open=false as |panel|}}
                    {{preprint-form-header name=(if nodeLocked 'preprint_file' 'choose_file') selectedFile=selectedFile showValidationIndicator=false}}
                    {{#panel.body}}
                        <form class="form">
                            <div class="toggle-button">
                                <div class="row">
                                    <div class="col-xs-6 col-sm-3 col-sm-offset-3 text-center">
                                        <input id='existing' class="radio_item" onchange={{action 'changeExistingState' _existingState.NEWFILE}} type="radio" checked={{eq existingState _existingState.NEWFILE}}>
                                        <label for="existing" class='choose-large'><i class="fa fa-cloud-upload"></i> {{t "components.preprint-form-project-select.upload_preprint"}}</label>
                                    </div>
                                    <div class="col-xs-6 col-sm-3 text-center">
                                        <input id='newfile' class="radio_item" onchange={{action 'changeExistingState' _existingState.EXISTINGFILE}} type="radio" checked={{eq existingState _existingState.EXISTINGFILE}}>
                                        <label class='choose-large' for="newfile"><i class="fa fa-th-list"></i>{{t "components.preprint-form-project-select.select_existing_file"}}</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    {{/panel.body}}
                {{/panels.panel}}
            {{/if}}
            {{#if (eq existingState _existingState.EXISTINGFILE)}}
                <div>
                    {{#if osfProviderLoaded}}
                        {{#panels.panel class="upload-section-block" allowOpen=true name='selectExistingFile' open=false as |panel|}}
                            {{preprint-form-header name=(if nodeLocked 'preprint_file' choose_file) selectedFile=selectedFile showValidationIndicator=false}}
                            {{#panel.body}}
                                <div class="m-t-sm">
                                    <form class="form">
                                        <div class="toggle-button">
                                            <input id='existing' onchange={{action 'changeExistingState' _existingState.NEWFILE}} type="radio" checked={{eq existingState _existingState.NEWFILE}}>
                                            <label for="existing"><i class="fa fa-cloud-upload"></i> </label>

                                            <input id='newfile' onchange={{action 'changeExistingState' _existingState.EXISTINGFILE}} type="radio" checked={{eq existingState _existingState.EXISTINGFILE}}>
                                            <label for="newfile"><i class="fa fa-th-list"></i> </label>
                                        </div>
                                    </form>
                                </div>
                                {{old-file-browser rootItem=osfStorageProvider openFile=(action 'selectFile')}}
                            {{/panel.body}}
                        {{/panels.panel}}
                        {{#if (and selectedNode (or hasFile selectedFile)) use='crossFade'}}
                            {{#panels.panel class="upload-section-block" allowOpen=true  name='organize' open=false as |panel|}}
                                {{preprint-form-header isTopLevelNode=isTopLevelNode convertOrCopy=convertOrCopy name='organize' showValidationIndicator=false}}
                                {{#panel.body}}
                                    {{convert-or-copy-project nextUploadSection=nextUploadSection clearDownstreamFields=clearDownstreamFields title=title node=node isTopLevelNode=isTopLevelNode titleValid=titleValid convertProjectConfirmed=convertProjectConfirmed convertOrCopy=convertOrCopy}}
                                {{/panel.body}}
                            {{/panels.panel}}
                            {{#if (or (eq convertOrCopy 'copy') (and (eq convertOrCopy 'convert') convertProjectConfirmed)) use='crossFade'}}
                                {{#panels.panel class="upload-section-block" allowOpen=true name='finalizeUpload' open=false as |panel|}}
                                    {{preprint-form-header title=title name='finalize_upload' showValidationIndicator=false}}
                                    {{#panel.body}}
                                        {{#if (eq convertOrCopy 'convert')}}
                                            {{#if convertProjectConfirmed}}
                                                <label class="text-muted title-label text-smaller">  {{if isTopLevelNode (t "components.preprint-form-project-select.edit_preprint_title_project") (t "components.preprint-form-project-select.edit_preprint_title_component")}} </label>
                                            {{/if}}
                                        {{/if}}
                                        <form onchange={{action 'track' 'input' 'onchange' 'Submit - Add title, Connect preprint to existing project'}}>
                                            {{preprint-title-editor title=title titleValid=titleValid pressSubmit=(action (if (eq convertOrCopy 'convert') existingNodeExistingFile createComponentCopyFile) name)}}
                                        </form>
                                        <div class="text-center m-v-md">
                                            <p> {{t "components.preprint-form-project-select.initiate_preprint_process"}} </p>
                                            <button class="btn btn-primary" disabled={{or (and (eq convertOrCopy 'convert') (not convertProjectConfirmed))(not (and selectedFile titleValid))}} {{action (if (eq convertOrCopy 'convert') existingNodeExistingFile createComponentCopyFile) name}}>{{t "submit.body.save_continue"}}</button>
                                        </div>
                                    {{/panel.body}}
                                {{/panels.panel}}
                            {{/if}}
                        {{/if}}
                    {{/if}}
                </div>
            {{else if (eq existingState _existingState.NEWFILE)}}
                {{file-uploader
                    changeInitialState=changeInitialState
                    nextUploadSection=nextUploadSection
                    changeExistingState = (action "changeExistingState")
                    isTopLevelNode=isTopLevelNode
                    finishUpload=finishUpload
                    startPreprint=startPreprint
                    startState=startState
                    title=title
                    currentUser=currentUser
                    osfFile=selectedFile
                    hasFile=hasFile
                    file=file
                    contributors=contributors
                    model=model
                    node=node
                    selectedNode=selectedNode
                    parentNode=parentNode
                    convertProjectConfirmed=convertProjectConfirmed
                    convertOrCopy=convertOrCopy
                    existingState=existingState
                    _existingState=_existingState
                    isTopLevelNode=isTopLevelNode
                    clearDownstreamFields=clearDownstreamFields
                    nodeLocked=nodeLocked
                    titleValid=titleValid
                    uploadChanged=uploadChanged
                    discardUploadChanges=discardUploadChanges
                    uploadInProgress=uploadInProgress
                    abandonedPreprint=abandonedPreprint
                    resumeAbandonedPreprint=resumeAbandonedPreprint
                    basicsAbstract=basicsAbstract
                    editMode=editMode
                    applyLicense=applyLicense
                    newNode=newNode
                }}
            {{/if}}
        {{else}}
            {{#unless (eq currentState 'start')}}
                <p class="alert alert-danger" role="alert">
                    {{t "components.preprint-form-project-select.admin_only"}}
                </p>
            {{/unless}}
        {{/if}}
    {{/if}}
{{/cp-panels}}
{{#unless nodeLocked}}
    <div class="p-t-xs">
        <button class="btn btn-default" {{action changeInitialState startState}}>{{t "global.back"}}</button>
    </div>
{{/unless}}
