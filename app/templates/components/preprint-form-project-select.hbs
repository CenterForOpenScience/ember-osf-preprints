{{#cp-panels accordion=true}}
    {{#unless preprintLocked}}
        {{!CHOOSE PROJECT SECTION}}
        {{#preprint-form-section class="upload-section-block" allowOpen=true name='chooseProject' open=true}}
            {{preprint-form-header name='choose_project' selectedNode=selectedNode showValidationIndicator=false}}
            {{#preprint-form-body}}
                <div class="m-t-sm">
                    {{#power-select search=(perform _getInitialUserNodes) optionsComponent=(component 'lazy-options' loadMore=(action "getMoreUserNodes") isLoading=isLoading canLoadMore=canLoadMore) oninput=(action "getDefaultUserNodes") onfocus=(action "onFocus") onblue=(action "onBlur") options=userNodes placeholder="Click to select" selected=selectedNode onchange=(action "nodeSelected") as |node|}}
                        {{get-ancestor-descriptor node}} <strong> {{node.title}}</strong>
                    {{/power-select}}
                </div>
                <p class="text-muted text-smaller m-t-xs">
                    {{t "components.preprint-form-project-select.existing_project_selector"}}
                </p>
            {{/preprint-form-body}}
        {{/preprint-form-section}}
    {{/unless}}
    {{#if (eq existingState _existingState.EXISTINGFILE)}}
        {{#if selectedNode}}
            {{#if isAdmin}}
                <div>
                    {{#if osfProviderLoaded}}
                        {{!CHOOSE EXISTING FILE SECTION}}
                        {{#preprint-form-section class="upload-section-block" allowOpen=true name='selectExistingFile' open=false}}
                            {{preprint-form-header name=(if preprintLocked 'preprint_file' 'choose_file') selectedFile=selectedFile showValidationIndicator=false}}
                            {{#preprint-form-body}}
                                {{old-file-browser rootItem=osfStorageProvider openFile=(action 'selectFile')}}
                            {{/preprint-form-body}}
                        {{/preprint-form-section}}
                        {{#if (and selectedNode (or hasFile selectedFile)) use='crossFade'}}
                            {{!FINALIZE UPLOAD SECTION - EXISTING FILE}}
                            {{#preprint-form-section class="upload-section-block" allowOpen=true name='finalizeUpload' open=false}}
                                {{preprint-form-header title=title name='finalize_upload' showValidationIndicator=false currentProvider=provider}}
                                {{#preprint-form-body}}
                                    <form role="button" onchange={{action 'track' 'input' 'onchange' 'Submit - Add title, Connect preprint to existing project'}}>
                                        {{preprint-title-editor documentType=provider.documentType title=title titleValid=titleValid pressSubmit=(action createPreprintCopyFile name)}}
                                    </form>
                                    <div class="text-center m-v-md">
                                        <button class="btn btn-primary" disabled={{or (not (and selectedFile titleValid))}} {{action createPreprintCopyFile}}>{{t "submit.body.save_continue"}}</button>
                                    </div>
                                {{/preprint-form-body}}
                            {{/preprint-form-section}}
                        {{/if}}
                    {{/if}}
                </div>
            {{else}}
                {{#if (not-eq currentState 'start')}}
                    <p class="alert alert-danger" role="alert">
                        {{t "components.preprint-form-project-select.admin_only"}}
                    </p>
                {{/if}}
            {{/if}}
        {{/if}}
    {{else if (eq existingState _existingState.NEWFILE)}}
        {{file-uploader
            changeInitialState=changeInitialState
            nextUploadSection=nextUploadSection
            changeExistingState=(action "changeExistingState")
            finishUpload=finishUpload
            setPrimaryFile=setPrimaryFile
            startState=startState
            title=title
            currentUser=currentUser
            osfFile=selectedFile
            hasFile=hasFile
            file=file
            contributors=contributors
            model=model
            node=node
            selectedNode=selectedNode
            existingState=existingState
            _existingState=_existingState
            clearDownstreamFields=clearDownstreamFields
            preprintLocked=preprintLocked
            titleValid=titleValid
            uploadChanged=uploadChanged
            discardUploadChanges=discardUploadChanges
            uploadInProgress=uploadInProgress
            abandonedPreprint=abandonedPreprint
            resumeAbandonedPreprint=resumeAbandonedPreprint
            basicsAbstract=basicsAbstract
            editMode=editMode
            applyLicense=applyLicense
            provider=provider
        }}
    {{/if}}
    {{#if chooseSupplementalProject}}
        {{#preprint-form-section class="upload-section-block" allowOpen=true name='chooseSupplementalProject' open=true}}
            {{#preprint-form-body}}
                <div class="m-t-sm">
                    {{#power-select search=(perform _getInitialUserNodes) optionsComponent=(component 'lazy-options' loadMore=(action "getMoreUserNodes") isLoading=isLoading canLoadMore=canLoadMore) oninput=(action "getDefaultUserNodes") onfocus=(action "onFocus") onblue=(action "onBlur") options=userNodes placeholder="Click to select" selected=selectedSupplementalProject onchange=(action "supplementalProjectSelected") as |node|}}
                        {{get-ancestor-descriptor node}} <strong> {{node.title}}</strong>
                    {{/power-select}}
                </div>
                <p class="text-muted text-smaller m-t-xs">
                    {{t "components.preprint-form-project-select.existing_project_selector"}}
                </p>
                <div class="row m-t-md">
                    <div class="col-md-12">
                        <div class="pull-right">
                            <button {{action changeSupplementalPickerState startState}} class="btn btn-default">{{t "global.discard"}}</button>
                            <button {{action setSupplementalTitleFromSelected}} disabled={{not selectedSupplementalProject}} class="btn btn-primary">{{t "components.project-chooser.continue"}}</button>
                        </div>
                    </div>
                </div>
            {{/preprint-form-body}}
        {{/preprint-form-section}}
    {{/if}}
{{/cp-panels}}
{{#unless preprintLocked}}
    <div class="p-t-xs">
        <button class="btn btn-default" {{action changeInitialState startState}}>{{t "global.back"}}</button>
    </div>
{{/unless}}
